<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZigaSwift Admin</title>
<style>
:root {
--bg: #0b1220;
--card: #121a2c;
--text: #e7eefc;
--muted: #9ab0d6;
--line: #22304f;
--ok: #3ddc97;
--bad: #ff6b6b;
--btn: #2b76ff;
--accept: #1f9d67;
--reject: #c86a14;
--delete: #d64545;
--pending: #d4a017;
}

* { box-sizing: border-box; }
body {
margin: 0;
font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
background: linear-gradient(180deg, #070b13, #0b1220);
color: var(--text);
}
header {
padding: 18px 16px;
border-bottom: 1px solid var(--line);
position: sticky;
top: 0;
background: rgba(11,18,32,.92);
backdrop-filter: blur(8px);
}
.wrap { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
.sub { color: var(--muted); font-size: 13px; margin-top: 6px; }
.grid { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 16px 0 32px; }
.card {
background: rgba(18,26,44,.9);
border: 1px solid var(--line);
border-radius: 14px;
padding: 16px;
}
.row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.pill {
padding: 6px 12px;
border: 1px solid var(--line);
border-radius: 999px;
color: var(--muted);
font-size: 12px;
}
input, input[type="search"] {
width: 100%;
max-width: 420px;
background: #0e1628;
border: 1px solid var(--line);
border-radius: 10px;
color: var(--text);
padding: 10px 12px;
font-size: 14px;
outline: none;
}
input::placeholder { color: #5a6f9c; }

button {
background: var(--btn);
color: white;
border: 0;
border-radius: 10px;
padding: 10px 14px;
font-weight: 600;
cursor: pointer;
transition: opacity .2s;
}
button:hover { opacity: .92; }
button:active { opacity: .8; }
button.secondary {
background: #1a2742;
border: 1px solid var(--line);
color: var(--text);
}
button.secondary:hover { background: #22304f; }

.msg { margin-top: 10px; font-size: 13px; color: var(--muted); }
.msg.ok { color: var(--ok); }
.msg.bad { color: var(--bad); }

table {
width: 100%;
border-collapse: collapse;
margin-top: 8px;
font-size: 13px;
}
th, td {
border-bottom: 1px solid var(--line);
padding: 10px 12px;
text-align: left;
vertical-align: middle;
}
th { color: var(--muted); font-weight: 600; }
.right { margin-left: auto; }

/* Status badge */
.status-badge {
padding: 4px 10px;
border-radius: 6px;
font-size: 11.5px;
font-weight: 600;
text-align: center;
min-width: 78px;
display: inline-block;
}
.status-pending { background: rgba(212,160,23,0.22); color: #ffdd77; border: 1px solid rgba(212,160,23,0.5); }
.status-accepted { background: rgba(31,157,103,0.22); color: #c5f7e0; border: 1px solid rgba(31,157,103,0.5); }
.status-rejected { background: rgba(214,69,69,0.22); color: #ffd6d6; border: 1px solid rgba(214,69,69,0.5); }
.status-unknown { background: rgba(100,100,100,0.3); color: #bbb; }

/* Actions */
.actions-cell {
padding: 8px 12px !important;
background: rgba(30,40,60,0.35);
}
.actions {
display: flex;
flex-wrap: nowrap;
gap: 8px;
align-items: center;
min-width: 240px;
}
.btn-sm {
padding: 6px 12px;
border-radius: 8px;
font-size: 12px;
font-weight: 700;
min-width: 74px;
text-align: center;
border: 1px solid rgba(255,255,255,.12);
cursor: pointer;
transition: all 0.13s;
}
.btn-sm:hover { filter: brightness(1.15); }
.btn-sm:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-accept { background: rgba(31,157,103,.22); color: #c5f7e0; border-color: rgba(31,157,103,.45); }
.btn-reject { background: rgba(200,106,20,.22); color: #ffe8cc; border-color: rgba(200,106,20,.45); }
.btn-delete { background: rgba(214,69,69,.22); color: #ffd6d6; border-color: rgba(214,69,69,.45); }
</style>
</head>
<body>

<header>
<div class="wrap">
<div class="row">
<div>
<h1>ZigaSwift Admin Dashboard</h1>
<div class="sub">Waitlist + Courier Applications</div>
</div>
<div class="right row">
<span class="pill">API: <code id="apiBaseLabel">loading…</code></span>
</div>
</div>
</div>
</header>

<main class="wrap">
<div class="grid">

<!-- Settings -->
<section class="card">
<div class="row"><h2 style="margin:0;font-size:16px">Settings</h2></div>
<div class="row" style="margin-top:12px; gap:16px;">
<label style="flex:1;">
<div class="small">API Base URL</div>
<input id="apiBase" placeholder="https://zigaswift-backend.onrender.com" />
</label>
<label style="flex:1; max-width:280px;">
<div class="small">Admin key</div>
<input id="adminKey" placeholder="Paste ADMIN_KEY here" />
</label>
<div style="display:flex; gap:10px;">
<button id="saveBtn">Save</button>
<button class="secondary" id="testBtn">Test API</button>
</div>
</div>
<div class="msg" id="settingsMsg"></div>
</section>

<!-- Waitlist -->
<section class="card">
<div class="row">
<h2 style="margin:0;font-size:16px">Waitlist</h2>
<div class="right row">
<button class="secondary" id="refreshWaitlist">Refresh</button>
</div>
</div>

<div class="row" style="margin:12px 0;">
<label style="flex:1; max-width:420px;">
<div class="small">Search (name, email, city, ID)</div>
<input id="waitlistSearch" type="search" placeholder="Filter..." />
</label>
</div>

<div class="msg" id="waitlistMsg"></div>

<div style="overflow-x:auto">
<table>
<thead>
<tr>
<th style="width:70px">ID</th>
<th>Name</th>
<th>Email</th>
<th>City</th>
<th>Created</th>
<th style="width:110px; text-align:center">Status</th>
<th style="width:280px; min-width:280px;">Actions</th>
</tr>
</thead>
<tbody id="waitlistBody"></tbody>
</table>
</div>
</section>

<!-- Couriers -->
<section class="card">
<div class="row">
<h2 style="margin:0;font-size:16px">Courier Applications</h2>
<div class="right row">
<button class="secondary" id="refreshCouriers">Refresh</button>
</div>
</div>

<div class="row" style="margin:12px 0;">
<label style="flex:1; max-width:420px;">
<div class="small">Search (name, email, route, ID)</div>
<input id="courierSearch" type="search" placeholder="Filter..." />
</label>
</div>

<div class="msg" id="courierMsg"></div>

<div style="overflow-x:auto">
<table>
<thead>
<tr>
<th style="width:70px">ID</th>
<th>Name</th>
<th>Email</th>
<th>Route</th>
<th>Created</th>
<th style="width:110px; text-align:center">Status</th>
<th style="width:280px; min-width:280px;">Actions</th>
</tr>
</thead>
<tbody id="courierBody"></tbody>
</table>
</div>
</section>

</div>
</main>

<script>
// ────────────────────────────────────────────────
// ZigaSwift Admin Dashboard – with search + status badges
// ────────────────────────────────────────────────

const DEFAULT_API_BASE = "https://zigaswift-backend.onrender.com";

const els = {
apiBase: document.getElementById("apiBase"),
adminKey: document.getElementById("adminKey"),
apiBaseLabel: document.getElementById("apiBaseLabel"),
saveBtn: document.getElementById("saveBtn"),
testBtn: document.getElementById("testBtn"),
settingsMsg: document.getElementById("settingsMsg"),
refreshWaitlist: document.getElementById("refreshWaitlist"),
refreshCouriers: document.getElementById("refreshCouriers"),
waitlistMsg: document.getElementById("waitlistMsg"),
courierMsg: document.getElementById("courierMsg"),
waitlistBody: document.getElementById("waitlistBody"),
courierBody: document.getElementById("courierBody"),
waitlistSearch: document.getElementById("waitlistSearch"),
courierSearch: document.getElementById("courierSearch"),
};

let waitlistFullData = [];
let couriersFullData = [];

function setMsg(el, text, type = "") {
el.textContent = text || "";
el.className = "msg" + (type ? " " + type : "");
}

function getConfig() {
let apiBase = (localStorage.getItem("ZS_ADMIN_API_BASE") || DEFAULT_API_BASE).trim().replace(/\/$/, '');
const adminKey = (localStorage.getItem("ZS_ADMIN_KEY") || "").trim();
return { apiBase, adminKey };
}

function saveConfig(apiBase, adminKey) {
localStorage.setItem("ZS_ADMIN_API_BASE", apiBase);
localStorage.setItem("ZS_ADMIN_KEY", adminKey);
}

function buildHeaders() {
const { adminKey } = getConfig();
const headers = { "Content-Type": "application/json" };
if (adminKey) headers["x-admin-key"] = adminKey;
return headers;
}

async function requestJSON(method, path) {
const { apiBase } = getConfig();
const url = `${apiBase}${path}`;

let res;
try {
res = await fetch(url, { method, headers: buildHeaders() });
} catch (err) {
throw new Error(`Network error: ${err.message}`);
}

let data;
try {
data = await res.json();
} catch {
throw new Error(`Invalid JSON (status ${res.status})`);
}

if (!res.ok) {
if (res.status === 401) {
throw new Error(getConfig().adminKey ? "Admin key rejected (401)" : "Admin key required (401)");
}
throw new Error(data?.error || data?.message || `Failed (${res.status})`);
}

return data;
}

function makeBtn(label, extraClass, onClick) {
const btn = document.createElement("button");
btn.type = "button";
btn.className = `btn-sm ${extraClass}`;
btn.textContent = label;
btn.addEventListener("click", onClick);
return btn;
}

function getStatusBadge(status) {
const s = (status || "pending").toLowerCase();
let text = "Pending";
let cls = "status-pending";

if (s === "accepted") {
text = "Accepted";
cls = "status-accepted";
} else if (s === "rejected") {
text = "Rejected";
cls = "status-rejected";
} else if (!["pending","accepted","rejected"].includes(s)) {
text = "Unknown";
cls = "status-unknown";
}

const span = document.createElement("span");
span.className = `status-badge ${cls}`;
span.textContent = text;
return span;
}

function renderEmptyRow(tbody, colSpan) {
tbody.innerHTML = "";
const tr = document.createElement("tr");
const td = document.createElement("td");
td.colSpan = colSpan;
td.textContent = "No records found.";
td.style.color = "#9ab0d6";
td.style.padding = "20px";
td.style.textAlign = "center";
tr.appendChild(td);
tbody.appendChild(tr);
}

function renderWaitlistRows(rows) {
const tbody = els.waitlistBody;
tbody.innerHTML = "";

if (!rows?.length) {
return renderEmptyRow(tbody, 7);
}

for (const r of rows) {
const tr = document.createElement("tr");

["id","name","email","city","created_at"].forEach(k => {
const td = document.createElement("td");
td.textContent = r[k] ?? "";
tr.appendChild(td);
});

// Status
const tdStatus = document.createElement("td");
tdStatus.style.textAlign = "center";
tdStatus.appendChild(getStatusBadge(r.status));
tr.appendChild(tdStatus);

// Actions
const tdActions = document.createElement("td");
tdActions.className = "actions-cell";
const wrap = document.createElement("div");
wrap.className = "actions";

const id = r.id;

wrap.append(
makeBtn("Accept", "btn-accept", async () => { await handleAction(`/api/admin/waitlist/${id}/accept`, els.waitlistSearch); }),
makeBtn("Reject", "btn-reject", async () => { await handleAction(`/api/admin/waitlist/${id}/reject`, els.waitlistSearch); }),
makeBtn("Delete", "btn-delete", async () => {
if (!confirm(`Delete waitlist #${id}?`)) return;
await handleAction(`/api/admin/waitlist/${id}`, els.waitlistSearch, "DELETE");
})
);

tdActions.appendChild(wrap);
tr.appendChild(tdActions);

tbody.appendChild(tr);
}
}

function renderCourierRows(rows) {
const tbody = els.courierBody;
tbody.innerHTML = "";

if (!rows?.length) {
return renderEmptyRow(tbody, 7);
}

for (const r of rows) {
const tr = document.createElement("tr");

["id","name","email","route","created_at"].forEach(k => {
const td = document.createElement("td");
td.textContent = r[k] ?? "";
tr.appendChild(td);
});

// Status
const tdStatus = document.createElement("td");
tdStatus.style.textAlign = "center";
tdStatus.appendChild(getStatusBadge(r.status));
tr.appendChild(tdStatus);

// Actions
const tdActions = document.createElement("td");
tdActions.className = "actions-cell";
const wrap = document.createElement("div");
wrap.className = "actions";

const id = r.id;

wrap.append(
makeBtn("Accept", "btn-accept", async () => { await handleAction(`/api/admin/couriers/${id}/accept`, els.courierSearch); }),
makeBtn("Reject", "btn-reject", async () => { await handleAction(`/api/admin/couriers/${id}/reject`, els.courierSearch); }),
makeBtn("Delete", "btn-delete", async () => {
if (!confirm(`Delete courier #${id}?`)) return;
await handleAction(`/api/admin/couriers/${id}`, els.courierSearch, "DELETE");
})
);

tdActions.appendChild(wrap);
tr.appendChild(tdActions);

tbody.appendChild(tr);
}
}

async function handleAction(path, searchInput, method = "PATCH") {
try {
await requestJSON(method, path);
if (searchInput) searchInput.value = ""; // optional: clear search after action
loadWaitlist();
loadCouriers();
} catch (err) {
alert(err.message);
}
}

function applyWaitlistFilter() {
const term = (els.waitlistSearch?.value || "").trim().toLowerCase();
let filtered = waitlistFullData;

if (term) {
filtered = waitlistFullData.filter(r =>
[r.id, r.name, r.email, r.city]
.map(v => String(v||'').toLowerCase())
.some(v => v.includes(term))
);
}

renderWaitlistRows(filtered);

if (filtered.length === 0 && waitlistFullData.length > 0) {
setMsg(els.waitlistMsg, `No matches for "${term}"`, "bad");
} else {
setMsg(els.waitlistMsg, `Showing ${filtered.length} of ${waitlistFullData.length}`, "ok");
}
}

function applyCourierFilter() {
const term = (els.courierSearch?.value || "").trim().toLowerCase();
let filtered = couriersFullData;

if (term) {
filtered = couriersFullData.filter(r =>
[r.id, r.name, r.email, r.route]
.map(v => String(v||'').toLowerCase())
.some(v => v.includes(term))
);
}

renderCourierRows(filtered);

if (filtered.length === 0 && couriersFullData.length > 0) {
setMsg(els.courierMsg, `No matches for "${term}"`, "bad");
} else {
setMsg(els.courierMsg, `Showing ${filtered.length} of ${couriersFullData.length}`, "ok");
}
}

async function loadWaitlist() {
setMsg(els.waitlistMsg, "Loading...");
try {
const data = await requestJSON("GET", "/api/admin/waitlist");
waitlistFullData = data.items || data || [];
applyWaitlistFilter();
setMsg(els.waitlistMsg, `Loaded ${waitlistFullData.length} records`, "ok");
} catch (err) {
setMsg(els.waitlistMsg, `❌ ${err.message}`, "bad");
}
}

async function loadCouriers() {
setMsg(els.courierMsg, "Loading...");
try {
const data = await requestJSON("GET", "/api/admin/couriers");
couriersFullData = data.items || data || [];
applyCourierFilter();
setMsg(els.courierMsg, `Loaded ${couriersFullData.length} records`, "ok");
} catch (err) {
setMsg(els.courierMsg, `❌ ${err.message}`, "bad");
}
}

async function testAPI() {
setMsg(els.settingsMsg, "Testing...");
try {
const { apiBase, adminKey } = getConfig();
const health = await fetch(`${apiBase}/api/health`);
if (!health.ok) throw new Error(`Health failed (${health.status})`);

const headers = adminKey ? { "x-admin-key": adminKey } : {};
const adminTest = await fetch(`${apiBase}/api/admin/waitlist`, { headers });
if (adminTest.status === 401) {
throw new Error(adminKey ? "Admin key rejected" : "Admin key required");
}
if (!adminTest.ok) throw new Error(`Admin check failed (${adminTest.status})`);

setMsg(els.settingsMsg, "✅ API + key OK", "ok");
} catch (err) {
setMsg(els.settingsMsg, `❌ ${err.message}`, "bad");
}
}

// Init
(function init() {
const { apiBase, adminKey } = getConfig();
els.apiBase.value = apiBase;
els.adminKey.value = adminKey;
els.apiBaseLabel.textContent = apiBase;

els.saveBtn.addEventListener("click", () => {
let api = els.apiBase.value.trim().replace(/\/$/, '');
if (!api.match(/^https?:\/\//)) api = "https://" + api;
if (!api) api = DEFAULT_API_BASE;
const key = els.adminKey.value.trim();

saveConfig(api, key);
els.apiBase.value = api;
els.adminKey.value = key;
els.apiBaseLabel.textContent = api;

setMsg(els.settingsMsg, "✅ Saved", "ok");
loadWaitlist();
loadCouriers();
});

els.testBtn.addEventListener("click", testAPI);
els.refreshWaitlist.addEventListener("click", () => { els.waitlistSearch.value = ""; loadWaitlist(); });
els.refreshCouriers.addEventListener("click", () => { els.courierSearch.value = ""; loadCouriers(); });

els.waitlistSearch.addEventListener("input", applyWaitlistFilter);
els.courierSearch.addEventListener("input", applyCourierFilter);

loadWaitlist();
loadCouriers();
})();
</script>
</body>
</html>
